<?xml version="1.0" encoding="utf-8" ?>
<!-- Copyright 2023 Manuel Regidor <manuel.regidor@sygel.es>
 License AGPL-3.0 or later (https://www.gnu.org/licenses/agpl). -->
<odoo>
    <template
        id="project_task_sign_timesheet_project_task_page"
        inherit_id="hr_timesheet.timesheet_project_task_page"
    >
        <xpath
            expr="//t[@t-if='doc.allow_timesheets and doc.timesheet_ids']/../.."
            position="after"
        >
            <div class="mb-5" />
        </xpath>
    </template>
    <template
        id="project_task_sign_timesheet_table"
        inherit_id="hr_timesheet.timesheet_table"
    >
        <xpath expr="div[hasclass('mt8')]" position="after">
            <div>
                <t
                    t-set="material_lines"
                    t-value="lines.mapped('task_id').mapped('move_ids').filtered(lambda a: a.quantity_done > 0.0)"
                />
                <t t-if="material_lines">
                    <div class="row mt8">
                        <div class="col-12">
                            <h2>
                                <br />
                                <span>Materials</span>
                            </h2>
                            <table class="table table-sm">
                                <thead>
                                  <tr>
                                    <th class="text-start align-middle">Name</th>
                                    <th
                                            class="text-start align-middle"
                                            t-if="show_project"
                                        ><span>Project</span></th>
                                    <th
                                            class="text-start align-middle"
                                            t-if="show_task"
                                        ><span>Task</span></th>
                                    <th class="text-end">Quantity</th>
                                  </tr>
                                </thead>
                                <tr
                                    t-foreach="material_lines"
                                    t-as="line"
                                    t-att-style="'background-color: #F1F1F1;' if line_index % 2 == 0 else ''"
                                >
                                    <td class="align-middle">
                                        <t t-esc="line.product_id.name" />
                                    </td>
                                    <td t-if="show_project" class="align-middle">
                                        <span t-field="line.project_id.sudo().name" />
                                    </td>
                                    <td t-if="show_task" class="align-middle">
                                        <span
                                            t-if="line.task_id"
                                            t-field="line.task_id.sudo().name"
                                        />
                                    </td>
                                    <td class="text-end">
                                        <t t-esc="line.product_uom_qty" /> <t
                                            t-esc="line.product_uom.name"
                                        />
                                        <t
                                            t-if="line.product_id.tracking in ['lot', 'serial'] and line.move_line_ids"
                                        >
                                            <t t-foreach="line.move_line_ids" t-as="s">
                                                <p
                                                    class="text-end p-0 m-0 text-muted lh-1"
                                                    style="font-size: 0.8rem;"
                                                >
                                                    <t t-esc="s.lot_id.name" />: <t
                                                        t-esc="s.qty_done"
                                                    /> <t
                                                        t-esc="s.product_uom_id.name"
                                                    />
                                                </p>
                                            </t>
                                        </t>
                                    </td>

                                </tr>
                            </table>
                        </div>
                    </div>
                </t>
                <t t-if="len(lines.task_id) == 1 and lines.task_id.signed">
                    <div
                        class="row mt8"
                        align="right"
                        t-if="lines.task_id.signature_img"
                    >
                        <div class="col-12">
                            <img
                                t-att-src="image_data_uri(lines.task_id.signature_img)"
                                style="width: 320px;"
                            />
                        </div>
                    </div>
                    <div
                        class="row mt8"
                        align="right"
                        t-if="lines.task_id.signature_name"
                    >
                        <div class="col-12">
                            <p t-esc="lines.task_id.signature_name" />
                        </div>
                    </div>
                    <div
                        class="row mt8"
                        align="right"
                        t-if="lines.task_id.signature_date"
                    >
                        <div class="col-12">
                            <p
                                t-field="lines.task_id.signature_date"
                                t-options="{'widget': 'datetime', 'format': 'dd/MM/YYYY - hh:mm'}"
                            />
                        </div>
                    </div>
                </t>
            </div>
        </xpath>
    </template>
</odoo>
